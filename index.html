<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Night Ink</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg: #0d0f14;
      --text: #e9e9ee;
      --muted: #9a9aa5;
      --divider: rgba(255,255,255,0.08);
      --accent: #c6c6ff;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Georgia, "Times New Roman", serif;
      line-height: 1.8;
    }

    header {
      max-width: 70ch;
      margin: 90px auto 60px;
      padding: 0 20px;
    }

    header h1 {
      font-size: 2.4rem;
      font-weight: normal;
      margin-bottom: 12px;
    }

    header p {
      color: var(--muted);
      font-size: 1rem;
    }

    main {
      max-width: 70ch;
      margin: auto;
      padding: 0 20px 120px;
      min-height: 200px;
    }

    .book {
      margin-bottom: 70px;
    }

    .book-title {
      font-size: 1.3rem;
      margin-bottom: 8px;
    }

    .book-desc {
      color: var(--muted);
      margin-bottom: 14px;
    }

    .book a {
      color: var(--accent);
      text-decoration: none;
      font-size: 0.95rem;
    }

    .book a:hover {
      text-decoration: underline;
    }

    hr {
      border: none;
      height: 1px;
      background: var(--divider);
      margin: 70px 0;
    }

    .status {
      color: var(--muted);
      font-style: italic;
    }

    footer {
      max-width: 70ch;
      margin: auto;
      padding: 40px 20px 80px;
      font-size: 0.85rem;
      color: var(--muted);
      text-align: center;
    }
  </style>
</head>
<body>

<header>
  <h1>Night Ink</h1>
  <p>A collection of stories, written over time.</p>
</header>

<main id="catalog">
  <p class="status">Loading stories...</p>
</main>

<footer>
  © 2026 — Written by K08149
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseClient = supabase.createClient(
    "https://plaxykqkhnbelwajltdk.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsYXh5a3FraG5iZWx3YWpsdGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTI1NTAsImV4cCI6MjA4NDE2ODU1MH0.nYpEAEBVZH-3WSUeBrSnCJSUYPopvmfzIXiUnlHwt7M"
  );

  async function loadBooks(retry = 0) {
    const catalog = document.getElementById("catalog");

    const { data, error } = await supabaseClient
      .from("books")
      .select("id, title, description")
      .order("created_at", { ascending: true });

    if (error) {
      console.error("Supabase error:", error);
      catalog.innerHTML = `<p class="status">Unable to load stories.</p>`;
      return;
    }

    // If DB is waking up (free tier cold start)
    if (!data || data.length === 0) {
      if (retry < 3) {
        catalog.innerHTML = `<p class="status">Waking the archive...</p>`;
        setTimeout(() => loadBooks(retry + 1), 2000);
        return;
      } else {
        catalog.innerHTML = `<p class="status">No stories available.</p>`;
        return;
      }
    }

    catalog.innerHTML = "";

    data.forEach((book, index) => {
      const div = document.createElement("div");
      div.className = "book";

      div.innerHTML = `
        <div class="book-title">${book.title}</div>
        <div class="book-desc">${book.description || ""}</div>
        <a href="book.html?book=${book.id}">Begin reading →</a>
      `;

      catalog.appendChild(div);

      if (index < data.length - 1) {
        catalog.appendChild(document.createElement("hr"));
      }
    });
  }

  loadBooks();
</script>

</body>
</html>  
